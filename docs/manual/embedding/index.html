<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Embedding - Faust Documentation</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <link href="/css/quickref.css" rel="stylesheet">
        <link href="/rail/railroad-diagrams.css" rel="stylesheet">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../.."><img src="../../img/faustText.svg" width="150px"> Documentation</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Faust Manual <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../introduction/" class="dropdown-item">Introduction</a>
</li>
                                    
<li>
    <a href="../overview/" class="dropdown-item">Overview of the Faust Universe</a>
</li>
                                    
<li>
    <a href="../quick-start/" class="dropdown-item">Quick start</a>
</li>
                                    
<li>
    <a href="../syntax/" class="dropdown-item">Faust Syntax</a>
</li>
                                    
<li>
    <a href="../compiler/" class="dropdown-item">Using the Compiler</a>
</li>
                                    
<li>
    <a href="../options/" class="dropdown-item">Compiler Options</a>
</li>
                                    
<li>
    <a href="../tools/" class="dropdown-item">faust2[...] Tools</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Embedding</a>
</li>
                                    
<li>
    <a href="../optimizing/" class="dropdown-item">Optimizing</a>
</li>
                                    
<li>
    <a href="../osc/" class="dropdown-item">OSC Support</a>
</li>
                                    
<li>
    <a href="../http/" class="dropdown-item">HTTP Support</a>
</li>
                                    
<li>
    <a href="../midi/" class="dropdown-item">MIDI Support</a>
</li>
                                    
<li>
    <a href="../soundfiles/" class="dropdown-item">Soundfiles Support</a>
</li>
                                    
<li>
    <a href="../mathdoc/" class="dropdown-item">Mathematical Documentation</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Examples <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../examples/ambisonics/" class="dropdown-item"> ambisonics </a>
</li>
                                    
<li>
    <a href="../../examples/analysis/" class="dropdown-item"> analysis </a>
</li>
                                    
<li>
    <a href="../../examples/bela/" class="dropdown-item"> bela </a>
</li>
                                    
<li>
    <a href="../../examples/delayEcho/" class="dropdown-item"> delayEcho </a>
</li>
                                    
<li>
    <a href="../../examples/dynamic/" class="dropdown-item"> dynamic </a>
</li>
                                    
<li>
    <a href="../../examples/filtering/" class="dropdown-item"> filtering </a>
</li>
                                    
<li>
    <a href="../../examples/gameaudio/" class="dropdown-item"> gameaudio </a>
</li>
                                    
<li>
    <a href="../../examples/generator/" class="dropdown-item"> generator </a>
</li>
                                    
<li>
    <a href="../../examples/misc/" class="dropdown-item"> misc </a>
</li>
                                    
<li>
    <a href="../../examples/phasing/" class="dropdown-item"> phasing </a>
</li>
                                    
<li>
    <a href="../../examples/physicalModeling/" class="dropdown-item"> physicalModeling </a>
</li>
                                    
<li>
    <a href="../../examples/pitchShifting/" class="dropdown-item"> pitchShifting </a>
</li>
                                    
<li>
    <a href="../../examples/psychoacoustic/" class="dropdown-item"> psychoacoustic </a>
</li>
                                    
<li>
    <a href="../../examples/reverb/" class="dropdown-item"> reverb </a>
</li>
                                    
<li>
    <a href="../../examples/SAM/" class="dropdown-item"> SAM </a>
</li>
                                    
<li>
    <a href="../../examples/smartKeyboard/" class="dropdown-item"> smartKeyboard </a>
</li>
                                    
<li>
    <a href="../../examples/spat/" class="dropdown-item"> spat </a>
</li>
                                    
<li>
    <a href="../../rsrc/examples.zip" class="dropdown-item"> Download examples </a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Tutorials <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../workshops/2020-04-10-faust-juce/" class="dropdown-item">Faust & JUCE</a>
</li>
                                    
<li>
    <a href="../../tutorials/teensy/" class="dropdown-item">DSP on the Teensy With Faust</a>
</li>
                                    
<li>
    <a href="../../tutorials/esp32/" class="dropdown-item">DSP on the ESP-32 With Faust</a>
</li>
                                    
<li>
    <a href="../../tutorials/basic-osc/" class="dropdown-item">Making a Sine Oscillator From Scratch</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Workshops <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../workshops/2018-12-01-paw/" class="dropdown-item"> 2018-12-01 PAW </a>
</li>
                                    
<li>
    <a href="../../workshops/2020-03-24-faust-citi/" class="dropdown-item"> 2020-03-24 CITI </a>
</li>
                                    
<li>
    <a href="../../workshops/2020-04-10-faust-101/" class="dropdown-item"> 2020-04-10 Faust 101 </a>
</li>
                                    
<li>
    <a href="../../workshops/2020-04-10-faust-juce/" class="dropdown-item"> 2020-04-10 Faust & JUCE </a>
</li>
                                    
<li>
    <a href="../../workshops/2020-11-21-faust-vcvrack/" class="dropdown-item"> 2020-11-21 Faust & VCV Rack </a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../../about/" class="nav-link">About</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        
        

        <div class="container">
            <div class="row"><div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#embedding-the-faust-compiler-using-libfaust" class="nav-link">Embedding the Faust Compiler Using libfaust</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#dynamic-compilation-chain" class="nav-link">Dynamic Compilation Chain</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#llvm" class="nav-link">LLVM</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#compiling-in-memory" class="nav-link">Compiling in Memory</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#savingrestoring-the-factory" class="nav-link">Saving/Restoring the Factory</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#additional-functions" class="nav-link">Additional Functions</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#using-the-libfaust-library" class="nav-link">Using the libfaust Library</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#use-case-examples" class="nav-link">Use Case Examples</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9 main-container" role="main">

<h1 id="embedding-the-faust-compiler-using-libfaust">Embedding the Faust Compiler Using <code>libfaust</code></h1>
<!-- TODO: this section could be further developed and better documented -->

<p>The combination of the awesome <a href="https://llvm.org/">LLVM technology</a> and <code>libfaust</code> (the library version of the Faust compiler) allows developers to compile and execute Faust DSP programs on the fly at full speed and without making compromises. In this section, we demonstrate how the Faust dynamic compilation chain can be used to embed the Faust compiler technology directly in applications or plug-ins.</p>
<h2 id="dynamic-compilation-chain">Dynamic Compilation Chain</h2>
<p>The Faust compiler uses an intermediate FIR representation (Faust Imperative Representation), which can be translated to several output languages. The FIR language describes the computation performed on the samples in a generic manner. It contains primitives to read and write variables and arrays, do arithmetic operations, and define the necessary control structures (<code>for</code> and <code>while</code> loops, <code>if</code> structure, etc.). </p>
<p>To generate various output languages, several backends have been developed: for C, C++, Java, LLVM IR, WebAssembly, etc. The native LLVM based compilation chain is particularly interesting: it provides direct compilation of a DSP source into executable code in memory, bypassing the external compiler requirement.</p>
<h2 id="llvm">LLVM</h2>
<p><a href="https://llvm.org/">LLVM (formerly Low Level Virtual Machine)</a> is a compiler infrastructure, designed for compile-time, link-time, and run-time optimization of programs written in arbitrary programming languages. Executable code is produced dynamically using a <em>Just In Time</em> compiler from a specific code representation, called LLVM IR. Clang, the LLVM native C/C++/Objective-C compiler is a front-end for the LLVM Compiler. It can, for instance, convert a C or C++ source file into LLVM IR code. Domain-specific languages like Faust can easily target the LLVM IR. This has been done by developing an LLVM IR backend in the Faust compiler.</p>
<h2 id="compiling-in-memory">Compiling in Memory</h2>
<p>The complete chain goes from the Faust DSP source code, compiled in LLVM IR using the LLVM backend, to finally produce the executable code using the LLVM JIT. All steps take place in memory, getting rid of the classical file-based approaches. Pointers to executable functions can be retrieved from the resulting LLVM module and the code directly called with the appropriate parameters.</p>
<p>The Faust compiler has been packaged as an embeddable library called <code>libfaust</code>, published with an associated API. Given a Faust source code (as a file or a string), calling the <code>createDSPFactoryXXX</code> function runs the compilation chain (Faust + LLVM JIT) and generates the <em>prototype</em> of the class, as a <code>llvm_dsp_factory</code> pointer.</p>
<p>Note that the library keeps an internal cache of all allocated <em>factories</em> so that the compilation of the same DSP code -- that is the same source code and the same set of <em>normalized</em> (sorted in a canonical order) compilation options -- will return the same (reference counted) factory pointer. </p>
<p><code>deleteDSPFactory</code> has to be explicitly used to properly decrement the reference counter when the factory is not needed anymore. You can get a unique SHA1 key of the created factory using its <code>getSHAKey</code> method.</p>
<p>Next, the <code>createDSPInstance</code> function (corresponding to the <code>new className</code> of C++) instantiates a <code>llvm_dsp</code> pointer to be used through its interface, connected to the audio chain and controller interfaces. When finished, <code>delete</code> can be used to destroy the dsp instance.</p>
<p>Since <code>llvm_dsp</code> is a subclass of the dsp base class, an object of this type can be used with all the available <code>audio</code> and <code>UI</code> classes. In essence, this is like reusing all architecture files already developed for the static C++ class compilation scheme like <code>OSCUI</code>, <code>httpdUI</code> interfaces, etc.</p>
<!-- TODO: we need an example here -->

<h2 id="savingrestoring-the-factory">Saving/Restoring the Factory</h2>
<p>After the DSP factory has been compiled, the application or the plug-in running it might need to save it and then restore it. To get the internal factory compiled code, several functions are available:</p>
<ul>
<li><code>writeDSPFactoryToIR</code>: get the DSP factory LLVM IR (in textual format) as a string, </li>
<li><code>writeDSPFactoryToIRFile</code>: get the DSP factory LLVM IR (in textual format) and write it to a file,</li>
<li><code>writeDSPFactoryToBitcode</code>: get the DSP factory LLVM IR (in binary format) as a string </li>
<li><code>writeDSPFactoryToBitcodeFile</code>: save the DSP factory LLVM IR (in binary format) in a file,</li>
<li><code>writeDSPFactoryToMachine</code>: get the DSP factory executable machine code as a string,</li>
<li><code>writeDSPFactoryToMachineFile</code>: save the DSP factory executable machine code in a file.</li>
</ul>
<p>To re-create a DSP factory from a previously saved code, several functions are available:</p>
<ul>
<li><code>readDSPFactoryFromIR</code>: create a DSP factory from a string containing the LLVM IR (in textual format), </li>
<li><code>readDSPFactoryFromIRFile</code>: create a DSP factory from a file containing the LLVM IR (in textual format),</li>
<li><code>readDSPFactoryFromBitcode</code>: create a DSP factory from a string containing the LLVM IR (in binary format), </li>
<li><code>readDSPFactoryFromBitcodeFile</code>: create a DSP factory from a file containing the LLVM IR (in binary format),</li>
<li><code>readDSPFactoryFromMachine</code>: create a DSP factory from a string containing the executable machine code,</li>
<li><code>readDSPFactoryFromMachineFile</code>: create a DSP factory from a file containing the executable machine code.</li>
</ul>
<h2 id="additional-functions">Additional Functions</h2>
<p>Some additional functions are available in the <code>libfaust</code> API:</p>
<ul>
<li><code>expandDSPFromString</code>/<code>expandDSPFromFile</code>: creates a self-contained DSP source string where all needed librairies have been included. All compilations options are normalized and included as a comment in the expanded string,</li>
<li><code>generateAuxFilesFromString</code>/<code>generateAuxFilesFromFile</code>: from a DSP source string or file, generates auxiliary files: SVG, XML, ps, etc. depending of the <code>argv</code> parameters.</li>
</ul>
<h2 id="using-the-libfaust-library">Using the <code>libfaust</code> Library</h2>
<p>The <code>libfaust</code> library is fully integrated to the Faust distribution. You'll have to compile and install it in order to use it. For an exhaustive documentation/description of the API, we advise you to have a look at the code in the <a href="https://github.com/grame-cncm/faust/blob/master-dev/architecture/faust/dsp/llvm-dsp.h"><code>faust/dsp/llvm-dsp.h</code></a> header file. Note that <code>faust/dsp/llvm-c-dsp.h</code> is a pure C version of the same API. Additional functions are available in <code>faust/dsp/libfaust.h</code> and their C version can be found in <code>faust/dsp/libfaust-c.h</code>.</p>
<p>More generally, a "typical" use of <code>libfaust</code> in C++ could look like:</p>
<pre><code>// the Faust code to compile as a string (could be in a file too)
string theCode = &quot;import(\&quot;stdfaust.lib\&quot;); process = no.noise;&quot;;

// compiling in memory (createDSPFactoryFromFile could be used alternatively)
llvm_dsp_factory* m_factory = createDSPFactoryFromString( 
  &quot;faust&quot;, theCode, argc, argv, &quot;&quot;, m_errorString, optimize);
// creating the DSP instance for interfacing
dsp* m_dsp = m_factory-&gt;createDSPInstance();

// creating a generic UI to interact with the DSP
my_ui* m_ui = new MyUI();
// linking the interface to the DSP instance 
m_dsp-&gt;buildUserInterface(m_ui);

// initializing the DSP instance with the SR
m_dsp-&gt;init(44100);

// hypothetical audio callback, assuming m_input/m_output are previously allocated 
while (...) {
  m_dsp-&gt;compute(128, m_input, m_output);
}

// cleaning
delete m_dsp;
delete m_ui;
deleteDSPFactory(m_factory);
</code></pre>
<p>The first step consists in creating a DSP factory from a DSP file (using <code>createDSPFactoryFromFile</code>) or string  (using <code>createDSPFactoryFromString</code>) with additional parameters given to the compiler. Assuming the compilation works, a factory is returned, to create a DSP instance with the factory <code>createDSPInstance</code> method. </p>
<p>Note that the resulting <code>llvm_dsp*</code> pointer type (see <a href="https://github.com/grame-cncm/faust/blob/master-dev/architecture/faust/dsp/llvm-dsp.h"><code>faust/dsp/llvm-dsp.h</code></a> header file) is a subclass of the base <code>dsp*</code> class (see <a href="https://github.com/grame-cncm/faust/blob/master-dev/architecture/faust/dsp/dsp.h"><code>faust/dsp/dsp.h</code></a> header file). Thus it can be used with any <code>UI</code> type to plug a GUI, MIDI or OSC controller on the DSP object, like it would be done with a DSP program compiled to a C++ class (the generated <code>mydsp</code>  class is also a subclass of the base <code>dsp*</code> class). This is demonstrated with the <code>my_ui* m_ui = new MyUI();</code> and <code>m_dsp-&gt;buildUserInterface(m_ui);</code> lines where the <code>buildUserInterface</code> method is used to connect a controller. </p>
<p>Then the DSP object has to be connected to an audio driver to be rendered (see the <code>m_dsp-&gt;compute(128, m_input, m_output);</code> block). A more complete C++ example can be <a href="https://github.com/grame-cncm/faust/blob/master-dev/tests/llvm-tests/llvm-test.cpp">found here</a>. A example using the pure C API can be <a href="https://github.com/grame-cncm/faust/blob/master-dev/tests/llvm-tests/llvm-test.c">found here</a>. </p>
<p>Thus, very few code is needed to embed Faust in your project!</p>
<h2 id="use-case-examples">Use Case Examples</h2>
<p>The dynamic compilation chain has been used in several projects:</p>
<ul>
<li><a href="https://github.com/grame-cncm/faustlive">FaustLive</a>: an integrated IDE for Faust development offering on-the-fly compilation and execution features</li>
<li><a href="https://github.com/grame-cncm/faust/tree/master-dev/embedded/faustgen">Faustgen</a>: a generic Faust <a href="https://cycling74.com/products/max/">Max/MSP</a> programmable external object</li>
<li><a href="https://github.com/CICM/pd-faustgen">Faustgen</a>: a generic Faust <a href="https://puredata.info">PureData</a> programmable external object</li>
<li><a href="https://github.com/csound/csound/blob/develop/Opcodes/faustgen.cpp">Faust for Csound</a>: a <a href="https://csound.com/">Csound</a> opcode running the Faust compiler internally</li>
<li><a href="https://github.com/sletz/libaudiostream">LibAudioStream</a>: a framework to manipulate audio ressources through the concept of streams</li>
<li><a href="https://github.com/olilarkin/juce_faustllvm">Faust for JUCE</a>: a tool integrating the Faust compiler to <a href="https://juce.com/">JUCE</a> developed by Oliver Larkin and available as part of the <a href="https://github.com/olilarkin/pMix2">pMix2 project</a></li>
<li>An experimental integration of Faust in <a href="http://forumnet.ircam.fr/product/antescofo-en/">Antescofo</a></li>
<li>FaucK: the combination of the <a href="http://chuck.cs.princeton.edu/">ChucK Programming Language</a> and Faust </li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2020 <a href="https://www.grame.fr">Grame-CNCM</a></p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
